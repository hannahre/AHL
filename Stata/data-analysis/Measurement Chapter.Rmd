---
title: "Measurement Chapter"
author: "Hannah Andrews"
date: "6/28/2021"
output:
  pdf_document: default
  html_document: default
  word_document: default
header-includes:
- \usepackage{float}
- \usepackage{sectsty}
- \usepackage{paralist}
- \usepackage{setspace}\spacing{1.5}
- \usepackage{fancyhdr}
- \usepackage{lastpage}
- \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(foreign)
library(expss)
library(Hmisc)
library(dplyr)
library(summarytools)
library(magrittr)
library(tidyverse)
library(mosaic)
library(lattice)
library(ggplot2)
library(scales)
library(ggthemes)
library(polycor)
library(psych)
library(REdaS)
library(haven)
library(labelled)
library(mice)
library(GPArotation)
library(foreach)
library(doParallel)
library(questionr)
library(gridExtra)
library(DAKS)
library(fdth)
library(lavaan)
library(corrplot)
library(knitr)
library(sna)
library(corrr)
library(gdata)
library(Rfast)
library(kableExtra)
library(janitor)
library(stargazer)
library(tables)
library(gtsummary)
library(pander)
library(validateR)
library(lavaan)
options(scipen = 999)
```

# Introduction 
*Intro: Why should CAMS fit together? Why should we care? What are the advantages of analyzing this â€“ pros and cons*

The defining of CAM is a fraught. The healing approaches encompassed by the term CAM are diverse. What unites them? In part, they have been defined by biomedicine in opposition to biomedicine (Gale 2014; Sointu 2021). The terms "complementary" and "alternative" themselves indicate difference from some norm, in this case the dominant paradigm of biomedicine. Issues of power struggles between biomedicine and other healing traditions and practices aside, this definition does seem to resonate with CAM users. Studies examining motivations for CAM use have found that some CAM users are motivated to use CAM due to the failure of biomedicine to address their ailments, particularly chronic conditions (cite). CAM users also report turning to CAM due to dissatifcation with interactions with biomedical physicians (cite). 

However, motivation for CAM use extends beyond dissatisfaction with biomedicine and biomedical definitions of health. 

In this chapter, I investigate whether there is an underlying construct or constructs driving the use of complementary and alternative medicines. This is in part an answer to the call from health lifestyles perspectives to examine the ways in which individual behaviors coalesce into meaningful behavioral patterns (Cockerham 2005). 
CAMs are also united by their holistic philosophies and the belief that individuals are experts on their own well-being (cite). 

o	What have others done to group them, including industry/professional groups?

There have been attempts by institutional bodies to organize CAMs into domains of similar practices. In the United Kingdom (UK), the House of Lords Select Committee on Science and Technology proposed that CAMs be categorized into three groups for research and policy purposes based on the CAM's claim regarding having its own distinct diagnostic approach (Mills 2001). These groups included (1) professionally organized alternative therapies, which includes therapies such as chiropractic and acupuncture; (2) complementary therapies, which includes therapies such as massage, hypnotherapy, and meditation and (3) alternative disciplines that may be further subdivided into long established and traditional systems of health care such as Ayurvedic medicine and other alternative disciplines such as crystal therapy.

In their Strategic Plan for 2005-2009, the National Center for Complementary and Alternative Medicine (NCCAM) grouped CAMs into four domains: (1) mind-body medicine, including practices such as meditation and yoga; (2) biologically based treatments, including practices such as use of herbs and vitamins and special diets; (3) manipulative and body-based practices, including practices such as chiropractic care and massage; and (4) energy medicine, including practices that involve the use of verifiable energy fields as well as biofields. NCCAM placed whole medical systems (e.g. Ayurveda, traditional Chinese Medicine) into a class of their own due to their use of practices that fall under multiple domains. On their current website, the National Center for Complementary and Integrative Health (NCCIH, formerly NCCAM) classifies CAMs into three domains based on their primary therapeutic input, and a fourth domain for practices that represent a combination of domains. The domains include (1) nutritional approaches, such as special diets, supplements, and herbs; (2) psychological approaches, such as meditation, hypnosis, and relaxation therapies; (3) physical approaches, such as acupuncture and massage; (4) combination approaches, for example practices that combine psychological and physical approaches such as yoga or tai chi. CAMs previously categorized as alternative medical systems involve multiple practices that are not easily fit in the new domains are not included in the classification.

(Can add in critiques of domains within research - See Ayers and Kronenfeld pg. 238)

Clearly there are many ways to justify the conceptual classifications of CAMs. CAMs vary in terms of their therapeutic input, their level of professional organization, and their relation to biomedicine. The question remains whether these classifications of CAMs represent actual patterns of CAM use. To my knowledge, there has been only one test of these proposed CAM domains in the literature. Ayers and Kronenfeld (2010) utilized data from the 2002 National Health Interview Survey (NHIS) to test whether the five domains (including whole medical systems) reflect actual patterns of CAM use using confirmatory factor analysis. After dropping CAMs that did not load properly (hypnosis, biofeedback, and energy healing), the authors found that the CAM domains proposed by NCCAM did not fit the data. The authors then conducted an exploratory factor analysis on the NHIS data. The authors found a well-fitting four factor solution. The four factors include mind-body medicine, alternative medical systems, prayer, and manipulative treatments. Meditation, guided imagery, relaxation, and deep breathing load onto mind-body medicine. Ayurveda, folk medicine, naturopathy, homeopathy, herbal therapy, vitamins, and biofeedback load onto alternative medical systems. Pray for self, asked others to pray for self, prayer groups, and healing rituals load onto prayer. Acupuncture, chiropractic, and massage load onto manipulative therapies. 

```{r, echo = FALSE}
# Create a table: Rows = CAMs. Columns = category the CAM is assigned to in each system
UK.input <- c("Professionally Organized Alt. Therapies", 
              "Complementary Therapies", 
              "Alternative Disciplines", 
              "Complementary Therapies", 
              "Professionally Organized Alt. Therapies", 
              "Complementary Therapies", 
              "Complementary Therapies", 
              "Alternative Disciplines", 
              "Complementary Therapies", 
              "Professionally Organized Alt. Therapies", 
              "Professionally Organized Alt. Therapies", 
              "Complementary Therapies", 
              "Complementary Therapies", 
              "Complementary Therapies", 
              "Alternative Disciplines", 
              "Complementary Therapies", 
              "Complementary Therapies", 
              "Complementary Therapies")
UK <- ordered(UK.input, levels = c("Alternative Disciplines", 
                                  "Professionally Organized Alt. Therapies",
                                  "Complementary Therapies"))
NCCAM.input <- c("Alternative Medical Systems", 
                 "Mind-Body Treatments",
                 "Alternative Medical Systems", 
                 "Mind-Body Treatments",
                 "Manipulative Treatments", 
                 "Mind-Body Treatments", 
                 "Energy Medicine", 
                 "Alternative Medical Systems", 
                 "Mind-Body Treatments", 
                 "Biologically Based Practices", 
                 "Alternative Medical Systems", 
                 "Mind-Body Treatments", 
                 "Manipulative Treatments", 
                 "Mind-Body Treatments", 
                 "Alternative Medical Systems",
                 "Mind-Body Treatments", 
                 "Biologically Based Practices", 
                 "Biologically Based Practices")
NCCAM <- ordered(NCCAM.input, levels = c("Alternative Medical Systems",
                                        "Biologically Based Practices",
                                        "Mind-Body Treatments", 
                                        "Manipulative Treatments", 
                                        "Energy Medicine"))
NCCIH.input <- c("Physical", "Psychological", 
                 "Alternative Medical Systems",
                 "Psychological and Physical", 
                 "Physical", 
                 "Psychological and Physical", 
                 NA, 
                 "Alternative Medical Systems", 
                 "Psychological and Physical", 
                 "Nutritional",
                 "Alternative Medical Systems", 
                 "Psychological", 
                 "Physical", 
                 "Psychological and Physical", 
                 "Alternative Medical Systems", 
                 "Psychological", 
                 "Nutritional", 
                 "Nutritional")
NCCIH <- ordered(NCCIH.input, levels = c("Alternative Medical Systems", 
                                        "Nutritional",
                                        "Psychological", 
                                        "Physical", 
                                        "Psychological and Physical"))
Ayers.input <- c("Manipulative Treatments", 
                 "Prayer", 
                 "Alternative Medical Systems", 
                 "Alternative Medical Systems", 
                 "Manipulative Treatments", 
                 "Mind-Body Medicine",
                 NA, 
                 "Alternative Medical Systems", 
                 "Mind-Body Medicine", 
                 "Alternative Medical Systems", 
                 "Alternative Medical Systems", 
                 NA, 
                 "Manipulative Treatments", 
                 "Mind-Body Medicine", 
                 "Alternative Medical Systems",
                 "Prayer", 
                 "Alternative Medical Systems", 
                 NA)
Ayers <- ordered(Ayers.input, levels = c("Alternative Medical Systems", 
                                        "Mind-Body Medicine",
                                        "Manipulative Treatments", 
                                        "Prayer"))
domains.df <- data.frame(UK, NCCAM, NCCIH, Ayers)
row.names(domains.df) <- c("Acupuncture", "Prayer", "Ayurveda", "Biofeedback", "Chiropractic", 
         "Deep breathing", "Energy healing", "Folk medicine", "Guided imagery", 
         "Herbal therapy", "Homeopathy", "Hypnosis", "Massage", "Meditation",
         "Naturopathy", "Healing ritual", "Vitamins", "Special Diet")
domains.df <- domains.df[
  with(domains.df, order(UK, NCCAM, NCCIH, Ayers)),
]
kable(domains.df,
      booktabs = T,
      col.names = c("UK House of Lords",
                  "NCCAM",
                  "NCCIH",
                  "Ayers and Kronenfeld (2010)"),
      caption = "CAM Classifications According to Institutions and Previous Research") %>%
  kable_classic(html_font = "CMU Serif") %>% 
  kableExtra::landscape()

#kable_styling(latex_options = "scale_down")
```

o	What are the advantages of using these data to test this?
MIDUS is representative of non-institutionalzed, English-speaking adults in the continental United States. 
MIDUS includes data on CAM use for a variety of CAMs. This is important for testing possible underlying constructs or groupings of CAMs. 

```{r, echo = FALSE, results = 'hide'}
# This chunk reads in the MIDUS1 Stata .dta file, subsets the data to only include CAMs, and restricts the data to complete cases. 

# Read in MIDUS1 data and subset to complete cases on CAMs
# Read in stata file for MIDUS 1
path <- ("C:/Users/hanna/Documents/git/AHL/Stata/data-cleaning/MIDUS1.dta")
M1 <- read_dta(path)
acamsList <- c("acam1", "acam2", "acam3", "acam4", "acam5", "acam6", "acam7", 
               "acam8", "acam9", "acam10", "acam11", "acam12", "acam13", "acam14", "acam15")

acams <- M1[acamsList] # Subset MIDUS1 - only include CAMs.

# Remove attributes from acams data - created in Stata (labels and data notes). They're (were) producing an error with bart_spher.
acams <- remove_attributes(acams, "label")
acams <- remove_attributes(acams, "notes")

str(acams)

# Create column that is the sum of CAMs used 
totalCams <- rowSums(acams[,1:15])

acams[sapply(acams, is.numeric)] <- lapply(acams[sapply(acams, is.numeric)], as.factor) # convert all columns to factors

str(acams) 
head(acams)

# Rename columns 
acams <- dplyr::rename(acams, 
                          aAcupuncture = acam1, 
                          aBiofeedback = acam2,
                          aChiropractic = acam3,
                          aEnergyHeal = acam4,
                          aExerciseMove = acam5,
                          aHerbal = acam6,
                          aVitamins = acam7,
                          aHomeopathy = acam8,
                          aHypnosis = acam9,
                          aImageryTech = acam10,
                          aMassage = acam11,
                          aPrayer = acam12,
                          aRelaxMeditate = acam13,
                          aSpecialDiet = acam14,
                          aSpiritHeal = acam15)
head(acams)
# Keep only complete cases
acams=acams[complete.cases(acams),]
str(acams)
```

```{r, echo = FALSE, results = 'hide'}
# This chunk reads in the MIDUS2 Stata .dta file, subsets the data to only include CAMs, and restricts the data to complete cases. 

# Prayer and spiritual healing combined in stata.

# Read in MIDUS2 data and subset to complete cases on CAMs
# Read in stata file for MIDUS 2
path <- ("C:/Users/hanna/Documents/git/AHL/Stata/data-cleaning/MIDUS2.dta")
M2 <- read_dta(path)
bcamsList <- c("bcam1", "bcam2", "bcam3", "bcam4", "bcam5", "bcam6", "bcam7", 
               "bcam8", "bcam9", "bcam10", "bcam11", "bcam12", "bcam13", "bcam14")

bcams <- M2[bcamsList] # Subset MIDUS2 - only include CAMs.

# Remove attributes from acams data - created in Stata (labels and data notes). They're (were) producing an error with bart_spher.
bcams <- remove_attributes(bcams, "label")
bcams <- remove_attributes(bcams, "notes")

str(bcams)

# Create column that is the sum of CAMs used 
btotalCams <- rowSums(bcams[,1:14])

bcams[sapply(bcams, is.numeric)] <- lapply(bcams[sapply(bcams, is.numeric)], as.factor) # convert all columns to factors

str(bcams) 
head(bcams)

# Rename columns 
bcams <- dplyr::rename(bcams, 
                         bAcupuncture = bcam1, 
                         bBiofeedback = bcam2,
                         bChiropractic = bcam3,
                         bEnergyHeal = bcam4,
                         bExerciseMove = bcam5,
                         bHerbal = bcam6,
                         bVitamins = bcam7,
                         bHomeopathy = bcam8,
                         bHypnosis = bcam9,
                         bImageryTech = bcam10,
                         bMassage = bcam11,
                         bPraySpirit = bcam12,
                         bRelaxMeditate = bcam13,
                         bSpecialDiet = bcam14)
head(bcams)
# Keep only complete cases
bcams=bcams[complete.cases(bcams),]
str(bcams)
```
```{r, echo = FALSE, results = 'hide'}
# This chunk reads in the MIDUS2 Stata .dta file, subsets the data to only include CAMs, and restricts the data to complete cases. 

# Prayer and spiritual healing combined in stata.

# Read in MIDUS2 data and subset to complete cases on CAMs
# Read in stata file for MIDUS 2
path <- ("C:/Users/hanna/Documents/git/AHL/Stata/data-cleaning/MIDUS3.dta")
M3 <- read_dta(path)
ccamsList <- c("ccam1", "ccam2", "ccam3", "ccam4", "ccam5", "ccam6", "ccam7", 
               "ccam8", "ccam9", "ccam10", "ccam11", "ccam12", "ccam13", "ccam14")

ccams <- M3[ccamsList] # Subset MIDUS2 - only include CAMs.

# Remove attributes from acams data - created in Stata (labels and data notes). They're (were) producing an error with bart_spher.
ccams <- remove_attributes(ccams, "label")
ccams <- remove_attributes(ccams, "notes")

str(ccams)

# Create column that is the sum of CAMs used 
ctotalCams <- rowSums(ccams[,1:14])

ccams[sapply(ccams, is.numeric)] <- lapply(ccams[sapply(ccams, is.numeric)], as.factor) # convert all columns to factors

str(ccams) 
head(ccams)

# Rename columns 
ccams <- dplyr::rename(ccams, 
                        cAcupuncture = ccam1, 
                        cBiofeedback = ccam2,
                        cChiropractic = ccam3,
                        cEnergyHeal = ccam4,
                        cExerciseMove = ccam5,
                        cHerbal = ccam6,
                        cVitamins = ccam7,
                        cHomeopathy = ccam8,
                        cHypnosis = ccam9,
                        cImageryTech = ccam10,
                        cMassage = ccam11,
                        cPraySpirit = ccam12,
                        cRelaxMeditate = ccam13,
                        cSpecialDiet = ccam14)
head(ccams)
# Keep only complete cases
ccams=ccams[complete.cases(ccams),]
str(ccams)
```

```{r, echo = FALSE, results = 'hide'}
# This code chunk creates a crosstab for prayer and spiritual healing in Wave 1 

# create new df with prayer and spiritual healing
my.vars <- c("aPrayer", "aSpiritHeal")
pray.spirit <- acams[my.vars]
  
# Assign yes/no values labels to prayer and spiritual healing 
pray.spirit$aPrayer <- ordered(pray.spirit$aPrayer,
                              levels = c(0,1), 
                              labels = c("No", "Yes"))
head(pray.spirit)
pray.spirit$aSpiritHeal <- ordered(pray.spirit$aSpiritHeal,
                                   levels = c(0, 1), 
                                   labels = c("No", "Yes"))
head(pray.spirit)

# Crosstab for prayer and spiritual healing
table.pray.spirit <- pray.spirit %>% 
  tabyl(aPrayer, aSpiritHeal) %>% 
  adorn_percentages("col") %>%
  adorn_totals(where = "row") %>% 
  adorn_pct_formatting() %>% 
  adorn_ns( position = "front") %>% 
  adorn_title(placement = "top", row_name = "Prayer", col_name = "Spiritual Healing")
```


```{r, echo = FALSE, results = 'hide'}
# This code chunk combines prayer and spiritual healing and drops aPrayer and aSpiritHeal 
acams <- acams %>% 
  rowwise() %>% 
  mutate(
    aPraySpirit = case_when(
      aPrayer == 0 & aSpiritHeal == 0 ~ 0,
      aPrayer == 1 & aSpiritHeal == 1 ~ 1, 
      aPrayer == 1 & aSpiritHeal == 0 ~ 1, 
      aPrayer == 0 & aSpiritHeal == 1 ~ 1)
    ) %>% 
  mutate_if(is.numeric, as.factor)
check.vars <- c("aPrayer", "aSpiritHeal", "aPraySpirit")
view(acams[check.vars])

# Check that code ran correctly with crosstabs 
# Prayer and Spiritual Healing
table.pray.spirit
# 4304 cases report no on both prayer and spiritual healing. aPraySpirit should have 4304 0/nos and 1853 1/yeses. 
table(acams$aPraySpirit)
# Correct.
# Check that no cases that responded yes on prayer are coded as 0 on the new variable.
acams %>%
  tabyl(aPrayer, aPraySpirit)
# Correct. 
# Chcek that no cases that responded yes on spiritual healing are coded as 0 on the new variable.
acams %>%  
  tabyl(aSpiritHeal, aPraySpirit)
# Correct. 
# Check that aPraySpirit is a factor.
class(acams$aPraySpirit)

# Drop prayer and spiritual healing columns 
acams <- subset(acams, select = -c(aPrayer, aSpiritHeal))
str(acams)
```

```{r, echo = FALSE, results='hide'}
# this chunk converts the tibble produced in the previous chunk to a matrix. 
# Code was written by Ron. See Andrews.Hannah.FacAn.Ron.script 

# What type of numbers do we have in the tibble "acams"? Let's see.
### Let's construct a matrix version of acams:
acams.matrix <- as.matrix(acams)
dim(acams.matrix)
head(acams.matrix)
acams.matrix <- as.numeric(acams.matrix)
dim(acams) # is: 6157 rows by 14 columns
6157 * 14 # is: 86,198
length(acams.matrix) # also 86,198
acams.matrix <- matrix(acams.matrix, ncol = 14)
dim(acams.matrix)
colnames(acams.matrix) <- names(acams)
head(acams.matrix)
head(acams) # They look the same.

# Now look at the numbers in acams.matrix:
table(as.vector(acams.matrix))
# All numbers are binary (0, 1)
colSums(acams.matrix)
sort(colSums(acams.matrix))
```

```{r, echo = FALSE, results = 'hide'}
# this code chunk sets up the frequencies visualization

### Write the program that Hannah used ("freq_dframer")

freq_dframer <- function(data){
  quest_out   <- apply(data, 2, questionr::freq)
  templist <- list()
  for (i in 1:length(names(quest_out))) {
    temp <- data.frame(Item = rep(names(quest_out[i]), nrow(quest_out[[i]])),
                       Category = row.names(quest_out[[i]]),
                       quest_out[[i]])
    templist[[i]] <- temp
  }
  freqs <- dplyr::bind_rows(templist) 
  row.names(freqs) <- NULL
  names(freqs)[3:5] <- c("Frequency", "Percent", "Pcnt_of_nonMissing") 
  freqs$Item <- factor(freqs$Item, levels = unique(freqs$Item))
  freqs
}
freqout <- freq_dframer(acams)

# Check with my matrix version:
freqout$Frequency[seq(2, 28, 2)]
colSums(acams.matrix)
sum(freqout$Frequency[seq(2, 28, 2)] != colSums(acams.matrix)) # They are the same.

# Frequency output for bcams
b.freqout <- freq_dframer(bcams)

# Frequency output for ccams 
c.freqout <- freq_dframer(ccams)
```

```{r, echo = FALSE, results = 'hide'}
# This code chunk creates a table that reports frequency and percent of respondents who have used each CAM in the last 12 months.

# Subset yes rows from the frequency table above
# MIDUS1
a.freqout.is1 <- freqout[seq(2, 28, 2),]
# MIDUS2 
b.freqout.is1 <- b.freqout[seq(2,28,2),]
# MIDUS3 
c.freqout.is1 <- c.freqout[seq(2, 28,2),]

# Subset frequency and percent columns
# MIDUS1 
freq.vars <- c("Frequency", "Percent")
freqs <- a.freqout.is1[freq.vars] 
# MIDUS2
b.freqs <- b.freqout.is1[freq.vars]
# MIDUS3
c.freqs <- c.freqout.is1[freq.vars]

# Rename columns for merging 
# MIDUS 1
freqs <- freqs %>% 
  rename(
    M1.Frequency = Frequency,
    M1.Percent = Percent
    )
# MIDUS 2
b.freqs <- b.freqs %>% 
  rename(
    M2.Frequency = Frequency,
    M2.Percent = Percent
    )
# MIDUS 3
c.freqs <- c.freqs %>% 
  rename(
    M3.Frequency = Frequency,
    M3.Percent = Percent
    )

# Assign rownames 
row.names(freqs) <- c("Acupuncture", "Biofeedback", "Chiropractic", "Energy Healing", 
                  "Exercise and Movement Therapy", "Herbal Therapy", "Vitamins", 
                  "Homeopathy", "Hypnosis", "Imagery Techniques", "Massage",
                  "Relaxation Techniques", "Special Diet", "Prayer or Spiritual Healing")
row.names(b.freqs) <- c("Acupuncture", "Biofeedback", "Chiropractic", "Energy Healing", 
                  "Exercise and Movement Therapy", "Herbal Therapy", "Vitamins", 
                  "Homeopathy", "Hypnosis", "Imagery Techniques", "Massage",
                  "Prayer or Spiritual Healing", "Relaxation Techniques", "Special Diet")
row.names(c.freqs) <- c("Acupuncture", "Biofeedback", "Chiropractic", "Energy Healing", 
                  "Exercise and Movement Therapy", "Herbal Therapy", "Vitamins", 
                  "Homeopathy", "Hypnosis", "Imagery Techniques", "Massage",
                  "Prayer or Spiritual Healing", "Relaxation Techniques", "Special Diet")

# Next, merge frequency dataframes for all three waves
# Merge freqs and b.freqs 
tmp.a.b <- merge(freqs, b.freqs, by = 0)
# Merge() created a new column row.names 
# Assign the row.names column to row names
rownames(tmp.a.b) <- tmp.a.b[,1]
# Remove Row.names column 
tmp.a.b[,1] <- NULL
# Merge c.freqs to tmp.a.b
all.freqs <- merge(tmp.a.b, c.freqs, by = 0)
# Assign the row.names column to row names
rownames(all.freqs) <- all.freqs[,1]
# Remove Row.names column 
all.freqs[,1] <- NULL

# Order rows by M1 frequency
all.freqs.ordered <- arrange(all.freqs, M1.Frequency)
```

# Data Description 
Data presented in the exploratory factor analysis come from Wave 1 of the Midlife in the United States (MIDUS) dataset. These data were collected between 1995 and 1996. Only cases with no missing values on the complementary and alternative medicine (CAM) items are included in analyses (*N* = 6157). 

## Measures Description  
Descriptive statistics for each CAM item are presented in Table 1. Biofeedback was the least used CAM (0.8%), followed by hypnosis (1.2%), acupuncture (1.2%), and energy healing (1.5%). Fewer than 100 people report using each of these CAMs. The most frequently utilized CAMs were prayer or spiritual healing (30%), exercise and movement therapy (17.5%), relaxation techniques (13.2%), and chiropractic care (12.0%).

```{r, echo = FALSE}
kable(all.freqs.ordered,
      booktabs = T,
      col.names = c("Wave 1 Frequency", 
                    "Wave 1 Percent", 
                    "Wave 2 Frequency", 
                    "Wave 2 Percent", 
                    "Wave 3 Frequency",
                    "Wave 3 Percent"),
      caption = "Descriptive Statistics for CAM Use in the Last 12 Months at each Wave") %>%
  kable_classic(html_font = "CMU Serif") %>% 
  kableExtra::landscape() %>% 
  add_footnote(c("Wave 1 n = 6157", "Wave 2 n = 3834", "Wave 3 n = 2675"), notation="number") 
```

(Move to data section.) It should be noted that utilization of prayer and spiritual healing was originally measured separately. Upon inspection of the data, I found that nearly all respondents who reported using spiritual healing also reported using prayer. Out of 196 respondents that report using spiritual healing, only 11 (5.6%) report using spiritual healing but not prayer for health or healing purposes. Given that these data were collected via survey, it is impossible to know exactly how the respondents interpreted the survey questions and how their interpretations effected the data collected. It does appear that the two questions measured the same behavior in those that use spiritual healing. The variables were combined so that all respondents that report using prayer or spiritual healing are coded as 1 or yes on the new prayer or spiritual healing variable.

```{r, echo = FALSE}
table.pray.spirit %>% 
  kable(caption = "Crosstab of Prayer and Spiritual Healing") %>% 
  kable_styling(bootstrap_options = c("basic"))
```

# Factor Analysis

In this section, I will present factor analysis results. First, I will present results from the exploratory factor analysis conducted using the Wave 1 data. Second, I will present results from the confirmatory factor analysis conducted on the solution found in the exploratory factor analysis using Wave 2 and Wave 3 data. 

```{r, echo = FALSE, fig.cap = "Tetrachoric Correlation Matrix"}
# Create correlation matrix 
het.mat.a <- hetcor(acams)$cor
# Rename columns for correlation matrix visualization 
colnames(het.mat.a) <- c("Acupuncture", "Biofeedback", "Chiropractic", "Energy Healing", 
                  "Exercise", "Herbal Therapy", "Vitamins", 
                  "Homeopathy", "Hypnosis", "Imagery", "Massage", 
                  "Relaxiation", "Special Diet", "Prayer/Spiritual Healing")
rownames(het.mat.a) <- c("Acupuncture", "Biofeedback", "Chiropractic", "Energy Healing", 
                  "Exercise", "Herbal Therapy", "Vitamins", 
                  "Homeopathy", "Hypnosis", "Imagery Techniques", "Massage",
                  "Relaxiation Techniques", "Special Diet", "Prayer/Spiritual Healing")
```


```{r, echo = FALSE, fig.cap = "Tetrachoric Correlations for CAM items"}
#corrplot.mixed(het.mat, tl.pos = "lt", tl.col = "black", tl.cex = .8, tl.srt=45, number.cex = .5, lower.col = "black", order = "hclust")
# col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
# corrplot(het.mat.a, method="color", number.cex = .5, order="hclust", 
#         addCoef.col = "black", # Add coefficient of correlation
#         tl.col="black", tl.srt=45 #Text label color and rotation
#         )
corrplot(het.mat.a, method = "number", number.cex = .5, order = "hclust", tl.col = "black")
```

## Exploratory Factor Analysis: Wave 1 

### Assumption Testing

```{r, echo = FALSE, results='hide'}
# This code chunk explores inter-item correlations 

# Create new matrix that is equal to het.mat.a to be used for exploring correlations
asymm.mat <- het.mat.a
upperTriangle(asymm.mat, diag=TRUE, byrow=FALSE) <- NA
asymm.mat

# Create matrix with NAs on diagonal (remove item correlations with themselves)
# Copy het.mat.a
no.diag <- het.mat.a
# Replace diagonals with NAs
diag(no.diag) <- NA
no.diag

# Range of correlations
# Highest correlation in the matrix
max(asymm.mat, na.rm = TRUE)
# Lowest correlation in the matrix
apply(het.mat.a, 1, FUN = min, na.rm = TRUE)
apply(no.diag, 1, FUN = max, na.rm = TRUE)
min(asymm.mat, na.rm = TRUE)

# How many correlations greater than .299
length(asymm.mat[asymm.mat>.299 & !is.na(asymm.mat)])
# How many correlations below .3
length(asymm.mat[asymm.mat<.3 & !is.na(asymm.mat)])
# Percent of correlations greater than .299
length(asymm.mat[asymm.mat>.299 & !is.na(asymm.mat)])/length(asymm.mat[!is.na(asymm.mat)])

# Columns with values less than .3
# Check whether each item correlates with at least one other item at .3
corr.max <- apply(no.diag,2,max, na.rm=TRUE)
corr.max > .3

no.diag <- as.data.frame(no.diag)


sum(no.diag$Acupuncture > .3, na.rm = TRUE)

```

```{r, echo = FALSE, results = 'hide'}
# This code chunk tests for correlation adequacy using Bartlett's test
bartlett <- cortest.bartlett(het.mat.a, n = nrow(acams))
bart.chisq <- round(cortest.bartlett(het.mat.a, n = nrow(acams))$chisq, 2)
```
```{r, echo = FALSE, results = 'hide'}
# This code chunk tests for sampling adequacy using the Kaiser-Meyer-Olkin (KMO) test
KMO(het.mat.a)
kmo <- round(KMO(het.mat.a)$MSA, 2)
```
The factorability of the 14 CAM items was examined. First, it was observed that all items correlated with at least one other item with a correlation of .3, suggesting factorability. Next, the Kaiser-Meyer-Olkin measure of sampling adequacy was `r kmo`, above the recommended value of at least .6. Bartlett's test of sphericity was significant ($\chi$^2^(`r bartlett$df`) = `r bart.chisq`, *p* <.01) indicating that the correlations between variables are higher than would be expected by chance.    

```{r, echo = FALSE, results = 'hide'}
# This code chunk runs a parallel test 
# Convert acams to numerics for parallel analysis
acams[] <- lapply(acams, function(x) as.numeric(as.character(x)))
str(acams)
parallel.all.cams <- fa.parallel(het.mat.a, n.obs = nrow(acams), fm = "ml", fa = "fa", main = "Parallel Analysis Scree Plot")
```
```{r, echo = FALSE, results='hide'}
# older kaiser criterion, number of eigenvalues greater than 1 
sum(parallel.all.cams$fa.values > 1.0)
# new kaiser criterion, number of eigenvalues greater than 0.7
sum(parallel.all.cams$fa.values > .7)
```
### Results

```{r, echo = FALSE, results = 'hide'}
# This code chunk runs all models with all CAMs. 

# Create empty data frame to be filled with fit statistics 
acams_all_fit_table_efa <- data.frame(Model=0, CFI=0, TLI=0, BIC=0, RMSR=0, RMSEA=0, Factors=0, FactorMethod=0, Rotation=0)  
# Create counter to be used in the loop to input statistics into successive rows
counter <- 1
# Write nested loops to run factor models on 1 through 6 factor solutions using all factoring methods and rotations and input model results into the data frame created above 
acams_all_fit_table_efa <- foreach (i=1:6) %:%
  foreach(j=c("ml", "minres", "pa")) %:%
    foreach (k=c("varimax", "promax", "oblimin", "cluster")) %do% {
      model_i_j_k<- fa(r = het.mat.a, nfactors = i, n.obs=nrow(acams), rotate = k, max.iter = 100, fm = j)
      acams_all_fit_table_efa [counter,"Model"] <- paste0(model_i_j_k$factors, model_i_j_k$fm, model_i_j_k$rotation)
      acams_all_fit_table_efa [counter,"CFI"] <- 1 - ((model_i_j_k$STATISTIC-model_i_j_k$dof)/(model_i_j_k$null.chisq-model_i_j_k$null.dof))
      acams_all_fit_table_efa [counter,"TLI"] <- model_i_j_k$TLI
      acams_all_fit_table_efa [counter,"BIC"] <- model_i_j_k$BIC
      acams_all_fit_table_efa [counter,"RMSR"] <- model_i_j_k$rms
      acams_all_fit_table_efa [counter,"RMSEA"] <- model_i_j_k$RMSEA[1]
      acams_all_fit_table_efa [counter, "Factors"] <- model_i_j_k$factors
      acams_all_fit_table_efa [counter, "FactorMethod"] <- model_i_j_k$fm
      acams_all_fit_table_efa [counter, "Rotation"] <- model_i_j_k$rotation
      return(acams_all_fit_table_efa)
      counter <- counter + 1 
    }

# Convert the nested lists created by the nested loops above to a data frame. 
# 6 columns 72 rows (72 models)
acams_all_df_unstacked <- unstack(data.frame(d<-unlist(acams_all_fit_table_efa),names(d)))
acams_all_df_unstacked

# Turn "Model" column into row names
acams_all_df_rownames <- data.frame(acams_all_df_unstacked[,-5],
                                  row.names=acams_all_df_unstacked[,5])
acams_all_df_rownames

# Reorder columns
col_order <- c("Factors", "FactorMethod", "Rotation", "BIC", "TLI", "CFI", "RMSR", "RMSEA")
acams_all_df_rownames2 <- acams_all_df_rownames[, col_order]
acams_all_df_rownames2

str(acams_all_df_rownames2)

# All columns are character vectors.
# Convert appropriate columns to numeric.
cols.num <- c("Factors", "BIC", "TLI", "CFI", "RMSR", "RMSEA")
acams_all_df_rownames2[cols.num] <- sapply(acams_all_df_rownames2[cols.num],as.numeric)
sapply(acams_all_df_rownames2, class)

# Round numeric values to four decimal places
acams_all_df <- modify_if(acams_all_df_rownames2, ~is.numeric(.), ~round(., 4))
```
```{r, echo = FALSE, results='hide'}
# 6 factor maximum likelihood solution had the best fit statistics above. Fit statistics are the same for all rotation methods. Check factor loadings for all rotation methods.
all.6.ml.varimax <- fa(r = het.mat.a, nfactors = 6, n.obs=nrow(acams), rotate = "varimax", max.iter = 100, fm = "ml")
all.6.ml.varimax$loadings
all.6.ml.promax <- fa(r = het.mat.a, nfactors = 6, n.obs=nrow(acams), rotate = "promax", max.iter = 100, fm = "ml")
all.6.ml.promax$loadings
all.6.ml.cluster <- fa(r = het.mat.a, nfactors = 6, n.obs=nrow(acams), rotate = "cluster", max.iter = 100, fm = "ml")
all.6.ml.cluster$loadings
all.6.ml.oblimin <- fa(r = het.mat.a, nfactors = 6, n.obs=nrow(acams), rotate = "oblimin", max.iter = 100, fm = "ml")
all.6.ml.oblimin$loadings
```

```{r, echo = FALSE, results = 'hide'}
# Factor loadings for 5 factor solutions
all.5.ml.varimax <- fa(r = het.mat.a, nfactors = 5, n.obs=nrow(acams), rotate = "varimax", max.iter = 100, fm = "ml")
all.5.ml.varimax$loadings
all.5.ml.promax <- fa(r = het.mat.a, nfactors = 5, n.obs=nrow(acams), rotate = "promax", max.iter = 100, fm = "ml")
all.5.ml.promax$loadings
# In the 5 factor solutions so far, CAMs are loading on multiple factors fairly evenly. Herbal and homeopathy and prayer/spiritual healing. 
all.5.ml.cluster <- fa(r = het.mat.a, nfactors = 5, n.obs=nrow(acams), rotate = "cluster", max.iter = 100, fm = "ml")
all.5.ml.cluster$loadings
# Actually this cluster solution looks pretty good. Prayer/spirit is loading on two factors, and biofeedback is loading on its own factor. Otherwise the factor groupings make sense. 
all.5.ml.oblimin <- fa(r = het.mat.a, nfactors = 5, n.obs=nrow(acams), rotate = "oblimin", max.iter = 100, fm = "ml")
all.5.ml.oblimin$loadings
```
First, I ran the exploratory factor analysis on all 14 CAMs. After examining one through six factor solutions using different extraction and rotation methods (See Appendix (create appendix for model fit statistics including all CAMs)), I found that the five and six factor maximum likelihood solutions fit the data best; however, biofeedback consistently loaded onto its own factor. Biofeedback is utilized by the smallest number of respondents (48). In light of the few cases reporting use of biofeedback and failure to load with other items, I dropped biofeedback and ran the analysis with the other 13 CAMs. 
```{r, echo = FALSE, results = 'hide'}
# In the 5 and 6 factor solutions, biofeedback is loading on its own factor consistently. It also has the fewest cases reporting use over the last year. 
# Run analyses dropping biofeedback. 

# Drop biofeedback 
acams.drop.bio <- subset(acams, select = -c(aBiofeedback))
# Convert all columns to factors for tetrachoric correlations 
acams.drop.bio[sapply(acams.drop.bio, is.numeric)] <- lapply(acams.drop.bio[sapply(acams.drop.bio, is.numeric)], as.factor)
str(acams.drop.bio)

# Create new correlation matrix
het.mat.drop.bio <- hetcor(acams.drop.bio)$cor

# Create empty data frame to be filled with fit statistics 
acams_drop_bio_fit_table_efa <- data.frame(Model=0, CFI=0, TLI=0, BIC=0, RMSR=0, RMSEA=0, Factors=0, FactorMethod=0, Rotation=0)  
# Create counter to be used in the loop to input statistics into successive rows
counter <- 1
# Write nested loops to run factor models on 1 through 6 factor solutions using all factoring methods and rotations and input model results into the data frame created above 
acams_drop_bio_efa_fit <- foreach (i=1:5) %:%
  foreach(j=c("ml", "minres")) %:%
    foreach (k=c("varimax", "promax", "oblimin", "cluster")) %do% {
      model_i_j_k<- fa(r = het.mat.drop.bio, nfactors = i, n.obs=nrow(acams), rotate = k, max.iter = 1000, fm = j)
      acams_drop_bio_fit_table_efa [counter,"Model"] <- paste0(model_i_j_k$factors, model_i_j_k$fm, model_i_j_k$rotation)
      acams_drop_bio_fit_table_efa [counter,"CFI"] <- 1 - ((model_i_j_k$STATISTIC-model_i_j_k$dof)/(model_i_j_k$null.chisq-model_i_j_k$null.dof))
      acams_drop_bio_fit_table_efa [counter,"TLI"] <- model_i_j_k$TLI
      acams_drop_bio_fit_table_efa [counter,"BIC"] <- model_i_j_k$BIC
      acams_drop_bio_fit_table_efa [counter,"RMSR"] <- model_i_j_k$rms
      acams_drop_bio_fit_table_efa [counter,"RMSEA"] <- model_i_j_k$RMSEA[1]
      acams_drop_bio_fit_table_efa [counter, "Factors"] <- model_i_j_k$factors
      acams_drop_bio_fit_table_efa [counter, "FactorMethod"] <- model_i_j_k$fm
      acams_drop_bio_fit_table_efa [counter, "Rotation"] <- model_i_j_k$rotation
      return(acams_drop_bio_fit_table_efa)
      counter <- counter + 1 
    }

# Convert the nested lists created by the nested loops above to a data frame. 
# 6 columns 72 rows (72 models)
acams_drop_bio_df_unstacked <- unstack(data.frame(d<-unlist(acams_drop_bio_efa_fit),names(d)))
acams_drop_bio_df_unstacked

# Turn "Model" column into row names
acams_drop_bio_df_rownames <- data.frame(acams_drop_bio_df_unstacked[,-5],
                                  row.names=acams_drop_bio_df_unstacked[,5])
acams_drop_bio_df_rownames

# Reorder columns
col_order <- c("Factors", "FactorMethod", "Rotation", "BIC", "TLI", "CFI", "RMSR", "RMSEA")
acams_drop_bio_df_rownames2 <- acams_drop_bio_df_rownames[, col_order]
acams_drop_bio_df_rownames2

str(acams_drop_bio_df_rownames2)

# All columns are character vectors.
# Convert appropriate columns to numeric.
cols.num <- c("Factors", "BIC", "TLI", "CFI", "RMSR", "RMSEA")
acams_drop_bio_df_rownames2[cols.num] <- sapply(acams_drop_bio_df_rownames2[cols.num],as.numeric)
sapply(acams_drop_bio_df_rownames2, class)

# Round numeric values to four decimal places
acams_drop_bio_df <- modify_if(acams_drop_bio_df_rownames2, ~is.numeric(.), ~round(., 4))
```

```{r, echo = FALSE, results='hide'}
# Maximum likelihood 5 factor solutions have best fit statistics. Review the factor loadings and groupings. 
drop.bio.5.ml.varimax <- fa(r = het.mat.drop.bio, nfactors = 5, n.obs=nrow(acams), rotate = "varimax", max.iter = 100, fm = "ml")
drop.bio.5.ml.varimax$loadings
drop.bio.5.ml.promax <- fa(r = het.mat.drop.bio, nfactors = 5, n.obs=nrow(acams), rotate = "promax", max.iter = 100, fm = "ml")
drop.bio.5.ml.promax$loadings
drop.bio.5.ml.oblimin <- fa(r = het.mat.drop.bio, nfactors = 5, n.obs=nrow(acams), rotate = "oblimin", max.iter = 100, fm = "ml")
drop.bio.5.ml.oblimin$loadings
drop.bio.5.ml.cluster <- fa(r = het.mat.drop.bio, nfactors = 5, n.obs=nrow(acams), rotate = "cluster", max.iter = 100, fm = "ml")
drop.bio.5.ml.cluster$loadings
# Consistent patterns: Acupuncture, herbal, vitamins, and homeopathy tend to load onto the same factor. This is also what Ayers and Kronenfeld found. Imagery tech, meditation, and prayer tend to go together. Imagery techniques also tend to load with hypnosis and energy healing. Exercise/movement is tending to load onto its own factor in the 5 factor solutions. Chiropractic and massage consistently load together. 
```
```{r, echo = FALSE, results = 'hide'}
# 4 factor maximum likelihood solutions fit the data well- some statistics are just below the cutoff, and the BIC is a bit higher. 
drop.bio.4.ml.varimax <- fa(r = het.mat.drop.bio, nfactors = 4, n.obs=nrow(acams), rotate = "varimax", max.iter = 100, fm = "ml")
drop.bio.4.ml.varimax$loadings
drop.bio.4.ml.promax <- fa(r = het.mat.drop.bio, nfactors = 4, n.obs=nrow(acams), rotate = "promax", max.iter = 100, fm = "ml")
drop.bio.4.ml.promax$loadings
drop.bio.4.ml.oblimin <- fa(r = het.mat.drop.bio, nfactors = 4, n.obs=nrow(acams), rotate = "oblimin", max.iter = 100, fm = "ml")
drop.bio.4.ml.oblimin$loadings
drop.bio.4.ml.cluster <- fa(r = het.mat.drop.bio, nfactors = 4, n.obs=nrow(acams), rotate = "cluster", max.iter = 100, fm = "ml")
drop.bio.4.ml.cluster$loadings
# Cluster solution looks pretty good- All the mind-body therapies load together. Acupuncture, herbal, and homeopathy load together - alternative systems. Chiropractic and massage load together - manipulative therapies. Exercise, vitamins, and special diet load together - physiological/nutrition. According to the NCCIH these would all be physical, but the difference between chiro/massage and diet/vitamins/nutrition is you don't need to see a professional (professionally organized therapies). 

# Assign CFI for the cluster solution to an object for inclusion in text 
drop.bio.4.ml.cluster.cfi <- 1 - ((drop.bio.4.ml.cluster$STATISTIC-drop.bio.4.ml.cluster$dof)/(drop.bio.4.ml.cluster$null.chisq-drop.bio.4.ml.cluster$null.dof))
```

```{r, echo = FALSE}
# This code chunk creates a table of fit statistics for the final efa model 

# Create empty dataframe
fa.fit.statistics <- data.frame(Model=0, Chi.Square=0, CFI=0, TLI=0, RMSR=0, RMSEA=0)  

# Add in fit statistics from the efa model 
fa.fit.statistics[1, "Model"] <- "Wave 1 Exploratory Factor Analysis"
fa.fit.statistics[1, "Chi.Square"] <- paste(round(drop.bio.4.ml.cluster$STATISTIC, 3),"(", drop.bio.4.ml.cluster$dof, ")", " p<.001", sep = "")
fa.fit.statistics[1, "CFI"] <- round(1 - ((model_i_j_k$STATISTIC-model_i_j_k$dof)/(model_i_j_k$null.chisq-model_i_j_k$null.dof)), 2)
fa.fit.statistics[1, "TLI"] <- round(drop.bio.4.ml.cluster$TLI, 2)
fa.fit.statistics[1, "RMSR"] <- round(drop.bio.4.ml.cluster$rms, 3)
fa.fit.statistics[1, "RMSEA"] <- round(drop.bio.4.ml.cluster$RMSEA[1], 3)
```

I ran one through five factor models using various extraction and rotation methods (See Appendix (model fit statistics dropping biofeedback)). While the five factor maximum likelihood solutions fit the data best, the four factor maximum likelihood solution with cluster rotation fit the data nearly as well and produced more interpretable factors. The four factor maximum likelihood solution with cluster rotation was chosen as the final measurement model. Model fit was evaluated using the chi-squared statistic, root mean square of approximation (RMSEA), root mean square residual (RMSR), comparative fit index (CFI), and Tucker-Lewis index (TLI). The null hypothesis for the $\chi$^2^ states that the model fits the analyzed covariance matrix (maybe reword), thus a significant $\chi$^2^ indicates a poor fitting model. It should be noted that the $\chi$^2^ is sensitive to large sample sizes and may indicate a model is a poor fit by mistake (Byrne 1989). The normed $\chi$^2^ ($\chi$^2^/*df*) minimizes this sensitivity. The $\chi$^2^ for the model presented here indicates poor fit $\chi$^2^(`r round(drop.bio.4.ml.cluster$dof, 3)`)=`r round(drop.bio.4.ml.cluster$STATISTIC, 3)`, *p*<.001. The CFI is above the desired cutoff of 0.90 (CFI=`r round(drop.bio.4.ml.cluster.cfi, 3)`). The TLI is just below the desired cutoff of 0.90 (TFI= `r round(drop.bio.4.ml.cluster$TLI, 3)`). The RMSR indicates good fit (RMSR= `r round(drop.bio.4.ml.cluster$rms, 3)`); however, the RMSEA is higher than the desirable 0.08 cutoff (RMSEA= `r round(drop.bio.4.ml.cluster$RMSEA[1],3)`). 

```{r, echo = FALSE}
# Import organized loadings table from excel
loadings.table <- read.csv(
  file = "EFA-loadings-table.csv",
  header = TRUE,
  sep = ",",
  dec = ".",
  stringsAsFactors = TRUE
)

# Function to control line separation in kable 
linesep<-function(x,y=character()){
  if(!length(x))
    return(y)
  linesep(x[-length(x)], c(rep('',x[length(x)]-1),'\\addlinespace',y))  
}
# Set NAs as blank in kable loadings table 
options(knitr.kable.NA = '')
```
```{r, efa-loadings-table, echo = FALSE}
# Print loadings table 
kable(loadings.table,
      booktabs = T,
      linesep = linesep(c(6, 4, 4)),
      col.names = c("",
                  "Factor 1",
                  "Factor 2",
                  "Factor 3", 
                  "Factor 4", 
                  "Communality", 
                  "Uniqueness", 
                  "Item Complexity"),
      caption = "Exploratory Factor Analysis of CAMs Wave 1 (n = 6157)") %>%
  kable_classic(html_font = "CMU Serif") %>% 
  kableExtra::landscape()
```

The four factors in the final model account for `r round(drop.bio.4.ml.cluster$Vaccounted["Cumulative Var","ML3"],2)` of the variance in the data. 

The cluster rotation factor loadings for the 13 CAM types are shown in Table \ref{tab:efa-loadings-table}. Five items had moderate to high loadings on Factor 1, Mind-Body Medicine (prayer or spiritual healing, energy healing, imagery techniques, relaxation and meditation techniques, and hypnosis). This factor measures the use of the mind to improve health and wellness. Three items had moderate to high loadings on Factor 2, Alternative Medical Systems (homeopathy, herbal therapy, and acupuncture). This factor measures use of CAM build on complete systems of theory and practice. Three items loaded moderately to heavily on Factor 3, Physical and Nutritional Approaches (vitamins, exercise and movement, and special diet). This factor measures... Two items loaded moderately to heavily on Factor 4, Manipulative Treatments (massage and chiropractic care). This factor measures use of external physical manipulation to promote health and wellness. 

```{r, echo = FALSE, results='hide'}
# Check reliability for the 4 Factor Solution using Maximum Likelihood and cluster rotation. Prayer and spiritual healing have been combined, and biofeedback dropped (because it was loading onto its own factor). 

# Convert acams.drop.bio to numeric 
acams.drop.bio[] <- lapply(acams.drop.bio, function(x) as.numeric(as.character(x)))
str(acams.drop.bio)
# Calculate Kuder-Richardson coefficient for binary data 
kr20(acams.drop.bio)

# Reliability for factor 1 
f1 <- acams.drop.bio[c("aEnergyHeal", "aHypnosis", "aImageryTech", "aRelaxMeditate", "aPraySpirit")]
head(f1)
kr20(f1)

# Reliability for factor 2 
f2 <- acams.drop.bio[c("aAcupuncture", "aHerbal", "aHomeopathy")]
head(f2)
kr20(f2)
# Reliability for factor 3 
f3 <- acams.drop.bio[c("aExerciseMove", "aVitamins", "aSpecialDiet")]
head(f3)
kr20(f3)
# Reliability for factor 4 
f4 <- acams.drop.bio[c("aChiropractic", "aMassage")]
head(f4)
kr20(f4)
```
(Insert reliability discussion here.)

## Confirmatory Factor Analysis: All waves
```{r, echo = FALSE, results='hide'}
# Run confirmatory factor analysis on the 4 factor ML cluster solution (drop bio)

# Convert acams.drop.bio columns to ordered factors
## Convert to factors 
acams.drop.bio[] <- lapply(acams.drop.bio[], as.factor)
head(acams.drop.bio)
## Order factors
acams.drop.bio[] <- lapply(acams.drop.bio, function(x) factor(x, 
                                                              levels = c("0", "1"),             
                                                              ordered = TRUE))
str(acams.drop.bio)
# Check that frequencies are the same
drop.bio.freqs <- freq_dframer(acams.drop.bio)
# Add print out of acams freqencies here 
drop.bio.freqs 
# They are the same. 

# Assigning items to factors 
efa.model <- 'f1 =~ aPraySpirit + aHypnosis + aImageryTech + aRelaxMeditate + aEnergyHeal
        f2 =~ aAcupuncture + aHerbal + aHomeopathy
        f3 =~ aExerciseMove + aVitamins + aSpecialDiet
        f4 =~ aChiropractic + aMassage '
# Run CFA model 
fit <- cfa(efa.model, data = acams.drop.bio,
             ordered = TRUE)
# Review fit statistics
summary.fit.1 <- summary(fit, fit.measures = TRUE)
summary(fit, standardized = TRUE)
# Helpful link/tutorial: https://benwhalley.github.io/just-enough-r/cfa.html
# sempaths documentation: https://www.rdocumentation.org/packages/semPlot/versions/1.1.2/topics/semPaths
```

```{r, echo = FALSE, results = 'hide'}
# This code chunk explores the modification indices- whether freeing parameter constraints or adding paths to the model would help improve it. 

modificationindices(fit) %>% 
  as.data.frame() %>%  # read the modification indices output in as a dataframe
  arrange(-mi) %>%  # sorts the rows by the mi column, which represents the change in the model chi-square we see if the path was included
  filter(mi > 10) %>%  # filter the results to show only those with chi-square change > 10
  select(lhs, op,rhs, mi, epc) %>%  # select only these columns from the modification indices output
  pander(caption = "Largest MI values for CFA")

# The largest mi suggests exercise/movement should be linked to Factor 4
# Model with largest mi change 
efa.model.2 <- 'f1 =~ aPraySpirit + aHypnosis + aImageryTech + aRelaxMeditate + aEnergyHeal
        f2 =~ aAcupuncture + aHerbal + aHomeopathy
        f3 =~ aVitamins + aSpecialDiet
        f4 =~ aChiropractic + aMassage + aExerciseMove'
# Run CFA model 
fit.2 <- cfa(efa.model.2, data = acams.drop.bio,
             ordered = TRUE)

# Compare fit statistics 
fit.stats.1 <- fitmeasures(fit, c("cfi", "tli", "rmsea", "bic"))
fit.stats.2 <- fitmeasures(fit.2, c("cfi", "tli", "rmsea", "bic"))
fit.stats.1
fit.stats.2

# No change to the fit statistics. Look at full model summary
summary.fit.2 <- summary(fit.2, fit.measures = TRUE)

# Model Plot 
semPlot::semPaths(fit, "std")
```

```{r, echo = FALSE, results='hide'}
# Run confirmatory factor analysis on the 4 factor ML cluster solution (drop bio) at Wave 2 

# Drop biofeedback 
bcams.drop.bio <- subset(bcams, select = -c(bBiofeedback))

# Order factors
bcams.drop.bio[] <- lapply(bcams.drop.bio, function(x) factor(x, 
                                                              levels = c("0", "1"),             
                                                              ordered = TRUE))

# Check that frequencies are the same
drop.bio.freqs <- freq_dframer(bcams.drop.bio)
b.freqout.is1 
drop.bio.freqs 
# They are the same. 

# Assigning items to factors 
b.cfa <- 'f1 =~ bPraySpirit + bHypnosis + bImageryTech + bRelaxMeditate + bEnergyHeal
        f2 =~ bAcupuncture + bHerbal + bHomeopathy
        f3 =~ bExerciseMove + bVitamins + bSpecialDiet
        f4 =~ bChiropractic + bMassage '
# Run CFA model 
b.fit <- cfa(b.cfa, data = bcams.drop.bio,
             ordered = TRUE)
# Review fit statistics
b.fit.summary <- summary(b.fit, fit.measures = TRUE)
summary(b.fit, standardized = TRUE)
# Helpful link/tutorial: https://benwhalley.github.io/just-enough-r/cfa.html
# sempaths documentation: https://www.rdocumentation.org/packages/semPlot/versions/1.1.2/topics/semPaths
```

```{r, echo = FALSE, results='hide'}
# Run confirmatory factor analysis on the 4 factor ML cluster solution (drop bio) at Wave 3 

# Drop biofeedback 
ccams.drop.bio <- subset(ccams, select = -c(cBiofeedback))

# Order factors
ccams.drop.bio[] <- lapply(ccams.drop.bio, function(x) factor(x, 
                                                              levels = c("0", "1"),             
                                                              ordered = TRUE))
str(ccams.drop.bio)
# Check that frequencies are the same
drop.bio.freqs <- freq_dframer(ccams.drop.bio)
c.freqout.is1 
drop.bio.freqs 
# They are the same. 

# Assigning items to factors 
c.cfa <- 'f1 =~ cPraySpirit + cHypnosis + cImageryTech + cRelaxMeditate + cEnergyHeal
        f2 =~ cAcupuncture + cHerbal + cHomeopathy
        f3 =~ cExerciseMove + cVitamins + cSpecialDiet
        f4 =~ cChiropractic + cMassage '
# Run CFA model 
c.fit <- cfa(c.cfa, data = ccams.drop.bio,
             ordered = TRUE)
# Review fit statistics
c.fit.summary <- summary(c.fit, fit.measures = TRUE, standardized = TRUE)
summary(c.fit, standardized = TRUE)
# Helpful link/tutorial: https://benwhalley.github.io/just-enough-r/cfa.html
# sempaths documentation: https://www.rdocumentation.org/packages/semPlot/versions/1.1.2/topics/semPaths
```

```{r gof-table, echo = FALSE}
# This code chunk adds fit statistics for the CFAs.

# Add in fit statistics from the wave 1 cfa model 
fa.fit.statistics[2, "Model"] <- "Wave 1 Confirmatory Factor Analysis"
fa.fit.statistics[2, "Chi.Square"] <- paste(round(fitMeasures(fit, "chisq"), 3),"(", fitMeasures(fit, "df"), ")", " p<.001", sep = "")
fa.fit.statistics[2, "CFI"] <- round(fitMeasures(fit, "cfi"), 2)
fa.fit.statistics[2, "TLI"] <- round(fitMeasures(fit, "tli"), 2)
fa.fit.statistics[2, "RMSR"] <- round(fitMeasures(fit, "rmr"), 3)
fa.fit.statistics[2, "RMSEA"] <- round(fitMeasures(fit, "rmsea"), 3)

# Add in fit statistics from the wave 2 cfa model 
fa.fit.statistics[3, "Model"] <- "Wave 2 Confirmatory Factor Analysis"
fa.fit.statistics[3, "Chi.Square"] <- paste(round(fitMeasures(b.fit, "chisq"), 3),"(", fitMeasures(b.fit, "df"), ")", " p<.001", sep = "")
fa.fit.statistics[3, "CFI"] <- round(fitMeasures(b.fit, "cfi"), 2)
fa.fit.statistics[3, "TLI"] <- round(fitMeasures(b.fit, "tli"), 2)
fa.fit.statistics[3, "RMSR"] <- round(fitMeasures(b.fit, "rmr"), 3)
fa.fit.statistics[3, "RMSEA"] <- round(fitMeasures(b.fit, "rmsea"), 3)

# Add in fit statistics from the wave 3 cfa model 
fa.fit.statistics[4, "Model"] <- "Wave 3 Confirmatory Factor Analysis"
fa.fit.statistics[4, "Chi.Square"] <- paste(round(fitMeasures(c.fit, "chisq"), 3),"(", fitMeasures(c.fit, "df"), ")", " p<.001", sep = "")
fa.fit.statistics[4, "CFI"] <- round(fitMeasures(c.fit, "cfi"), 2)
fa.fit.statistics[4, "TLI"] <- round(fitMeasures(c.fit, "tli"), 2)
fa.fit.statistics[4, "RMSR"] <- round(fitMeasures(c.fit, "rmr"), 3)
fa.fit.statistics[4, "RMSEA"] <- round(fitMeasures(c.fit, "rmsea"), 3)

# Add row for fit guidelines
fa.fit.statistics[5, "Model"] <- "Fit Guidelines"
fa.fit.statistics[5, "Chi.Square"] <- ""
fa.fit.statistics[5, "CFI"] <- paste(">.95")
fa.fit.statistics[5, "TLI"] <- paste(">.95")
fa.fit.statistics[5, "RMSR"] <- paste("<.08")
fa.fit.statistics[5, "RMSEA"] <- paste("<.08")

kable(fa.fit.statistics,
      booktabs = T,
      col.names = c("Model", 
                    "Chi-Square(df)", 
                    "CFI", 
                    "TLI", 
                    "RMSR", 
                    "RMSEA"),
      caption = "Goodness of Fit Statistics") %>%
  kable_classic(html_font = "CMU Serif") %>% 
  add_footnote(c("Wave 1 n = 6157, Wave 2 n = 3834, Wave 3 n = 2675", "Values meeting fit guidelines indicate good model-data fit."), notation="number") 

```

```{r, echo = FALSE}
# Import organized loadings table from excel
loadings.table <- read.csv(
  file = "CFA-std-loadings.csv",
  header = TRUE,
  sep = ",",
  dec = ".",
  stringsAsFactors = TRUE
)

# Function to control line separation in kable 
linesep<-function(x,y=character()){
  if(!length(x))
    return(y)
  linesep(x[-length(x)], c(rep('',x[length(x)]-1),'\\addlinespace',y))  
}
# Set NAs as blank in kable loadings table 
options(knitr.kable.NA = '')
```
```{r, cfa-loadings-table, echo = FALSE}
# Print loadings table 
kable(loadings.table,
      booktabs = T,
      linesep = linesep(c(6, 4, 4)),
      col.names = c("",
                  "Wave 1",
                  "Wave 2",
                  "Wave 3"),
      caption = "Confirmatory Factor Analysis Standardized Loadings for All Waves") %>%
  kable_classic(html_font = "CMU Serif")
```