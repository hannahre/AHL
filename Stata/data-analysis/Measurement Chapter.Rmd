---
title: "Measurement Chapter"
author: "Hannah Andrews"
date: "6/28/2021"
output:
  pdf_document: default
  html_document: default
header-includes:
  - \usepackage{float}
  - \usepackage{sectsty}
  - \usepackage{paralist}
  - \usepackage{setspace}\spacing{1.5}
  - \usepackage{fancyhdr}
  - \usepackage{lastpage}
  - \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(foreign)
library(expss)
library(Hmisc)
library(dplyr)
library(summarytools)
library(magrittr)
library(tidyverse)
library(mosaic)
library(lattice)
library(ggplot2)
library(scales)
library(ggthemes)
library(polycor)
library(psych)
library(REdaS)
library(haven)
library(labelled)
library(mice)
library(GPArotation)
library(foreach)
library(doParallel)
library(questionr)
library(gridExtra)
library(DAKS)
library(fdth)
library(lavaan)
library(validateR)
library(corrplot)
library(knitr)
library(sna)
library(corrr)
library(gdata)
library(Rfast)
library(kableExtra)
```

# Introduction 
*Intro: Why should CAMS fit together? Why should we care? What are the advantages of analyzing this â€“ pros and cons*

The defining of CAM is a fraught. The healing approaches encompassed by the term CAM are diverse. What unites them? In part, they have been defined by biomedicine in opposition to biomedicine (Gale 2014; Sointu 2021). The terms "complementary" and "alternative" themselves indicate difference from some norm, in this case the dominant paradigm of biomedicine. Issues of power struggles between biomedicine and other healing traditions and practices aside, this definition does seem to resonate with CAM users. Studies examining motivations for CAM use have found that some CAM users are motivated to use CAM due to the failure of biomedicine to address their ailments, particularly chronic conditions (cite). CAM users also report turning to CAM due to dissatifcation with interactions with biomedical physicians (cite). 

However, motivation for CAM use extends beyond dissatisfaction with biomedicine and biomedical definitions of health. 

In this chapter, I investigate whether there is an underlying construct or constructs driving the use of complementary and alternative medicines. This is in part an answer to the call from health lifestyles perspectives to examine the ways in which individual behaviors coalesce into meaningful behavioral patterns (Cockerham 2005). 
CAMs are also united by their holistic philosophies and the belief that individuals are experts on their own well-being (cite). 

o	What have others done to group them, including industry/professional groups?

There have been attempts by institutional bodies to organize CAMs into domains of similar practices. In the United Kingdom (UK), the House of Lords Select Committee on Science and Technology proposed that CAMs be categorized into three groups for research and policy purposes based on the CAM's claim regarding having its own distinct diagnostic approach (Mills 2001). These groups included (1) professionally organized alternative therapies, which includes therapies such as chiropractic and acupuncture; (2) complementary therapies, which includes therapies such as massage, hypnotherapy, and meditation and (3) alternative disciplines that may be further subdivided into long established and traditional systems of health care such as Ayurvedic medicine and other alternative disciplines such as crystal therapy.

In their Strategic Plan for 2005-2009, the National Center for Complementary and Alternative Medicine (NCCAM) grouped CAMs into four domains: (1) mind-body medicine, including practices such as meditation and yoga; (2) biologically based treatments, including practices such as use of herbs and vitamins and special diets; (3) manipulative and body-based practices, including practices such as chiropractic care and massage; and (4) energy medicine, including practices that involve the use of verifiable energy fields as well as biofields. NCCAM placed whole medical systems (e.g. Ayurveda, traditional Chinese Medicine) into a class of their own due to their use of practices that fall under multiple domains. On their current website, the National Center for Complementary and Integrative Health (NCCIH, formerly NCCAM) classifies CAMs into three domains based on their primary therapeutic input, and a fourth domain for practices that represent a combination of domains. The domains include (1) nutritional approaches, such as special diets, supplements, and herbs; (2) psychological approaches, such as meditation, hypnosis, and relaxation therapies; (3) physical approaches, such as acupuncture and massage; (4) combination approaches, for example practices that combine psychological and physical approaches such as yoga or tai chi. CAMs previously categorized as alternative medical systems involve multiple practices that are not easily fit in the new domains are not included in the classification.

(Can add in critiques of domains within research - See Ayers and Kronenfeld pg. 238)

Clearly there are many ways to justify the conceptual classifications of CAMs. CAMs vary in terms of their therapeutic input, their level of professional organization, and their relation to biomedicine. The question remains whether these classifications of CAMs represent actual patterns of CAM use. To my knowledge, there has been only one test of these proposed CAM domains in the literature. Ayers and Kronenfeld (2010) utilized data from the 2002 National Health Interview Survey (NHIS) to test whether the five domains (including whole medical systems) reflect actual patterns of CAM use using confirmatory factor analysis. After dropping CAMs that did not load properly (hypnosis, biofeedback, and energy healing), the authors found that the CAM domains proposed by NCCAM did not fit the data. The authors then conducted an exploratory factor analysis on the NHIS data. The authors found a well-fitting four factor solution. The four factors include mind-body medicine, alternative medical systems, prayer, and manipulative treatments. Meditation, guided imagery, relaxation, and deep breathing load onto mind-body medicine. Ayurveda, folk medicine, naturopathy, homeopathy, herbal therapy, vitamins, and biofeedback load onto alternative medical systems. Pray for self, asked others to pray for self, prayer groups, and healing rituals load onto prayer. Acupuncture, chiropractic, and massage load onto manipulative therapies. 

```{r, echo = FALSE}
# Create a table one row for each CAM and how they would be assigned in each system
UK.input <- c("Professionally Organized Alt. Therapies", 
              "Complementary Therapies", 
              "Alternative Disciplines", 
              "Complementary Therapies", 
              "Professionally Organized Alt. Therapies", 
              "Complementary Therapies", 
              "Complementary Therapies", 
              "Alternative Disciplines", 
              "Complementary Therapies", 
              "Professionally Organized Alt. Therapies", 
              "Professionally Organized Alt. Therapies", 
              "Complementary Therapies", 
              "Complementary Therapies", 
              "Complementary Therapies", 
              "Alternative Disciplines", 
              "Complementary Therapies", 
              "Complementary Therapies", 
              "Complementary Therapies")
UK <- ordered(UK.input, levels = c("Alternative Disciplines", 
                                  "Professionally Organized Alt. Therapies",
                                  "Complementary Therapies"))
NCCAM.input <- c("Alternative Medical Systems", 
                 "Mind-Body Treatments",
                 "Alternative Medical Systems", 
                 "Mind-Body Treatments",
                 "Manipulative Treatments", 
                 "Mind-Body Treatments", 
                 "Energy Medicine", 
                 "Alternative Medical Systems", 
                 "Mind-Body Treatments", 
                 "Biologically Based Practices", 
                 "Alternative Medical Systems", 
                 "Mind-Body Treatments", 
                 "Manipulative Treatments", 
                 "Mind-Body Treatments", 
                 "Alternative Medical Systems",
                 "Mind-Body Treatments", 
                 "Biologically Based Practices", 
                 "Biologically Based Practices")
NCCAM <- ordered(NCCAM.input, levels = c("Alternative Medical Systems",
                                        "Biologically Based Practices",
                                        "Mind-Body Treatments", 
                                        "Manipulative Treatments", 
                                        "Energy Medicine"))
NCCIH.input <- c("Physical", "Psychological", 
                 "Alternative Medical Systems",
                 "Psychological and Physical", 
                 "Physical", 
                 "Psychological and Physical", 
                 NA, 
                 "Alternative Medical Systems", 
                 "Psychological and Physical", 
                 "Nutritional",
                 "Alternative Medical Systems", 
                 "Psychological", 
                 "Physical", 
                 "Psychological and Physical", 
                 "Alternative Medical Systems", 
                 "Psychological", 
                 "Nutritional", 
                 "Nutritional")
NCCIH <- ordered(NCCIH.input, levels = c("Alternative Medical Systems", 
                                        "Nutritional",
                                        "Psychological", 
                                        "Physical", 
                                        "Psychological and Physical"))
Ayers.input <- c("Manipulative Treatments", 
                 "Prayer", 
                 "Alternative Medical Systems", 
                 "Alternative Medical Systems", 
                 "Manipulative Treatments", 
                 "Mind-Body Medicine",
                 NA, 
                 "Alternative Medical Systems", 
                 "Mind-Body Medicine", 
                 "Alternative Medical Systems", 
                 "Alternative Medical Systems", 
                 NA, 
                 "Manipulative Treatments", 
                 "Mind-Body Medicine", 
                 "Alternative Medical Systems",
                 "Prayer", 
                 "Alternative Medical Systems", 
                 NA)
Ayers <- ordered(Ayers.input, levels = c("Alternative Medical Systems", 
                                        "Mind-Body Medicine",
                                        "Manipulative Treatments", 
                                        "Prayer"))
domains.df <- data.frame(UK, NCCAM, NCCIH, Ayers)
row.names(domains.df) <- c("Acupuncture", "Prayer", "Ayurveda", "Biofeedback", "Chiropractic", 
         "Deep breathing", "Energy healing", "Folk medicine", "Guided imagery", 
         "Herbal therapy", "Homeopathy", "Hypnosis", "Massage", "Meditation",
         "Naturopathy", "Healing ritual", "Vitamins", "Special Diet")
domains.df <- domains.df[
  with(domains.df, order(UK, NCCAM, NCCIH, Ayers)),
]
kable(domains.df,
      booktabs = T,
      col.names = c("UK House of Lords",
                  "NCCAM",
                  "NCCIH",
                  "Ayers and Kronenfeld (2010)"),
      caption = "CAM Classifications According to Institutions and Previous Research") %>%
  kable_classic(html_font = "CMU Serif") %>% 
  kableExtra::landscape()

#kable_styling(latex_options = "scale_down")
```

o	What are the advantages of using these data to test this?
MIDUS is representative of non-institutionalzed, English-speaking adults in the continental United States. 
MIDUS includes data on CAM use for a variety of CAMs. This is important for testing possible underlying constructs or groupings of CAMs. 

```{r, echo = FALSE, results = 'hide'}
# This chunk reads in the Stata .dta file, subsets the data to only include CAMs, and restricts the data to complete cases. 

# Read in MIDUS1 data and subset to complete cases on CAMs
# Read in stata file for MIDUS 1
path <- ("C:/Users/hanna/Documents/git/AHL/Stata/data-cleaning/MIDUS1.dta")
M1 <- read_dta(path)
acamsList <- c("acam1", "acam2", "acam3", "acam4", "acam5", "acam6", "acam7", 
               "acam8", "acam9", "acam10", "acam11", "acam12", "acam13", "acam14", "acam15")

acams <- M1[acamsList] # Subset MIDUS1 - only include CAMs.

# Remove attributes from acams data - created in Stata (labels and data notes). They're (were) producing an error with bart_spher.
acams <- remove_attributes(acams, "label")
acams <- remove_attributes(acams, "notes")

str(acams)

# Create column that is the sum of CAMs used 
totalCams <- rowSums(acams[,1:15])

acams[sapply(acams, is.numeric)] <- lapply(acams[sapply(acams, is.numeric)], as.factor) # convert all columns to factors

str(acams) 
head(acams)

# Rename columns 
acams <- dplyr::rename(acams, 
                          aAcupuncture = acam1, 
                          aBiofeedback = acam2,
                          aChiropractic = acam3,
                          aEnergyHeal = acam4,
                          aExerciseMove = acam5,
                          aHerbal = acam6,
                          aVitamins = acam7,
                          aHomeopathy = acam8,
                          aHypnosis = acam9,
                          aImageryTech = acam10,
                          aMassage = acam11,
                          aPrayer = acam12,
                          aRelaxMeditate = acam13,
                          aSpecialDiet = acam14,
                          aSpiritHeal = acam15)
head(acams)
# Keep only complete cases
acams=acams[complete.cases(acams),]
str(acams)
```
```{r, echo = FALSE, results='hide'}
# this chunk converts the tibble produced in the previous chunk to a matrix. 
# Code was written by Ron. See Andrews.Hannah.FacAn.Ron.script 

# What type of numbers do we have in the tibble "acams"? Let's see.
### Let's construct a matrix version of acams:
acams.matrix <- as.matrix(acams)
dim(acams.matrix)
head(acams.matrix)
acams.matrix <- as.numeric(acams.matrix)
dim(acams) # is: 6157 rows by 15 columns
6157 * 15 # is: 92,355
length(acams.matrix) # also 92,355
acams.matrix <- matrix(acams.matrix, ncol = 15)
dim(acams.matrix)
colnames(acams.matrix) <- names(acams)
head(acams.matrix)
head(acams) # They look the same.

# Now look at the numbers in acams.matrix:
table(as.vector(acams.matrix))
# All numbers are binary (0, 1)
colSums(acams.matrix)
sort(colSums(acams.matrix))
```
```{r, echo = FALSE, results = 'hide'}
# this code chunk sets up the frequencies visualization

### Write the program that Hannah used ("freq_dframer")

freq_dframer <- function(data){
  quest_out   <- apply(data, 2, questionr::freq)
  templist <- list()
  for (i in 1:length(names(quest_out))) {
    temp <- data.frame(Item = rep(names(quest_out[i]), nrow(quest_out[[i]])),
                       Category = row.names(quest_out[[i]]),
                       quest_out[[i]])
    templist[[i]] <- temp
  }
  freqs <- dplyr::bind_rows(templist) 
  row.names(freqs) <- NULL
  names(freqs)[3:5] <- c("Frequency", "Percent", "Pcnt_of_nonMissing") 
  freqs$Item <- factor(freqs$Item, levels = unique(freqs$Item))
  freqs
}
freqout <- freq_dframer(acams)

# Check with my matrix version:
freqout$Frequency[seq(2, 30, 2)]
colSums(acams.matrix)
sum(freqout$Frequency[seq(2, 30, 2)] != colSums(acams.matrix)) # They are the same.
```

```{r, echo = FALSE, results = 'hide'}
# This code chunk creates a table that reports frequency and percent of respondents who have used each CAM in the last 12 months.

# Subset yes rows from the frequency table above
freqout.is1 <- freqout[seq(2, 30, 2),]
# Subset frequency and percent columns 
freq.vars <- c("Frequency", "Percent")
freqs <- freqout.is1[freq.vars]
# Assign rownames 
row.names(freqs) <- c("Acupuncture", "Biofeedback", "Chiropractic", "Energy Healing", 
                  "Exercise and Movement Therapy", "Herbal Therapy", "Vitamins", 
                  "Homeopathy", "Hypnosis", "Imagery Techniques", "Massage", "Prayer",
                  "Relaxiation Techniques", "Special Diet", "Spiritual Healing")
# Order rows by frequency
ordered.freqs <- arrange(freqs, Frequency)
```

# Data Description 
Data presented in this chapter come from Wave 1 of the Midlife in the United States (MIDUS). These data were collected between 1995 and 1996. Only cases with no missing values on the complementary and alternative medicine (CAM) items are included in analyses (*N* = 6157). 

## Measures Description  
Descriptive statistics for each CAM item are presented in Table 1. Biofeedback was the least used CAM (0.8%), followed by hypnosis (1.2%), acupuncture (1.2%), and energy healing (1.5%). Fewer than 100 people report using each of these CAMs. The most frequently utilized CAMs were prayer (29.9%), exercise and movement therapy (17.5%), relaxation techniques (13.2%), and chiropractic care (12.0%).

```{r, echo = FALSE}
# Print table of frequencies
kable(ordered.freqs, caption = "Descriptive Statistics for CAM Use in the Last 12 Months")
```

# Factor Analysis

In this section, I will present exploratory factor analysis results. While data screening revealed that the data are factorable, I did not find a factor solution that fit the the data. First, I ran factor models on all CAM items. Next, I ran factor models on all CAM items excluding prayer and spiritual healing. Then, in addition to prayer and spiritual healing I excluded all CAMs with fewer than 100 cases reporting use in the last year (biofeedback, hypnosis, acupuncture, and energy healing). Alternative factoring and rotation methods did not produce a well fitting factor solution. Fit statistics for models not presented in this chapter can be found in Appendix (insert letter). 

```{r, echo = FALSE, fig.cap = "Tetrachoric Correlation Matrix"}
# Create correlation matrix 
het.mat <- hetcor(acams)$cor
# Rename columns for correlation matrix visualization 
colnames(het.mat) <- c("Acupuncture", "Biofeedback", "Chiropractic", "Energy Healing", 
                  "Exercise", "Herbal Therapy", "Vitamins", 
                  "Homeopathy", "Hypnosis", "Imagery", "Massage", "Prayer",
                  "Relaxiation", "Special Diet", "Spiritual Healing")
rownames(het.mat) <- c("Acupuncture", "Biofeedback", "Chiropractic", "Energy Healing", 
                  "Exercise", "Herbal Therapy", "Vitamins", 
                  "Homeopathy", "Hypnosis", "Imagery Techniques", "Massage", "Prayer",
                  "Relaxiation Techniques", "Special Diet", "Spiritual Healing")
```
```{r, echo = FALSE, fig.cap = "Tetrachoric Correlations for CAM items"}
#corrplot.mixed(het.mat, tl.pos = "lt", tl.col = "black", tl.cex = .8, tl.srt=45, number.cex = .5, lower.col = "black", order = "hclust")
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(het.mat, method="color", number.cex = .5, order="hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45 #Text label color and rotation
         )
```

## Assumption Testing

```{r, echo = FALSE, results='hide'}
# This code chunk explores inter-item correlations 

# Create new matrix that is equal to het.mat to be used for exploring correlations
asymm.mat <- het.mat
upperTriangle(asymm.mat, diag=TRUE, byrow=FALSE) <- NA
asymm.mat

# Range of correlations
# Highest correlation in the matrix
max(asymm.mat, na.rm = TRUE)
# Lowest correlation in the matrix
min(asymm.mat, na.rm = TRUE)

# How many correlations greater than .299
length(asymm.mat[asymm.mat>.299 & !is.na(asymm.mat)])
# How many correlations below .3
length(asymm.mat[asymm.mat<.3 & !is.na(asymm.mat)])
# Percent of correlations greater than .299
length(asymm.mat[asymm.mat>.299 & !is.na(asymm.mat)])/length(asymm.mat[!is.na(asymm.mat)])

# Columns with values less than .3
# Copy het.mat
no.diag <- het.mat
# Replace diagonals with NAs
diag(no.diag) <- NA
no.diag
# Check whether each item correlates with at least one other item at .3
corr.max <- apply(no.diag,2,max, na.rm=TRUE)
corr.max > .3

no.diag <- as.data.frame(no.diag)


sum(no.diag$Acupuncture > .3, na.rm = TRUE)

```

All items correlate with at least one other item 

Out of `r length(asymm.mat[!is.na(asymm.mat)])` inter-item correlations, `r length(asymm.mat[asymm.mat<.3 & !is.na(asymm.mat)])` are less than .3. 

Sampling Adequacy 

## Factor solutions including all CAM items 


### Goodness of Fit 
### Reliability 
## Models excluding prayer and spiritual healing 
## Models excluding items with fewer than 100 cases 

