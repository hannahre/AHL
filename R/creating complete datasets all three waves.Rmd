---
title: "creating datasets with complete cases at all three waves"
author: "Hannah Andrews"
date: "11/10/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, echo = FALSE, results ='hide'}

# LCA pooled observations without biofeedback
dir <- "C:/Users/hanna/Documents/git/AHL/R"
setwd(dir)

# Load Libraries ####
library(expss)
library(Hmisc)
library(dplyr)
library(summarytools)
library(magrittr)
library(tidyverse)
library(mosaic)
library(lattice)
library(ggplot2)
library(scales)
library(ggthemes)
library(LCA)
library(poLCA)
library(haven)
library(labelled)
################################################################################
# Wave 1 
# This chunk reads in the MIDUS1 Stata .dta file, subsets the data to only include CAMs, and restricts the data to complete cases. 

# Read in MIDUS1 data and subset to complete cases on CAMs
# Read in stata file for MIDUS 1
path <- ("C:/Users/hanna/Documents/git/AHL/Stata/data-cleaning/MIDUS1.dta")
M1 <- read_dta(path)
varlist <- c("M2ID", "acam1", "acam2", "acam3", "acam4", "acam5", "acam6", "acam7", 
              "acam8", "acam9", "acam10", "acam11", "acam13", "acam14",
              "acam21", "AEduc", "ARace", "ASex", "lnAHhInc", "aMarried", "aHlthIns", "AAge", 
              "A1SCHROX", "A1SCHRON", "A1SHLOCS", "A1SHLOCO")

wave1 <- M1[varlist] # Subset MIDUS1 - only include CAMs.

# Create column that is the sum of CAMs used 
wave1 <- wave1 %>%
  mutate(totalCams = rowSums(wave1[, c(2:15)]))


# Rename columns 
wave1 <- dplyr::rename(wave1, 
                            Acupuncture_W1 = acam1, 
                            Biofeedback_W1 = acam2,
                            Chiropractic_W1 = acam3,
                            EnergyHeal_W1 = acam4,
                            ExerciseMove_W1 = acam5,
                            Herbal_W1 = acam6,
                            Vitamins_W1 = acam7,
                            Homeopathy_W1 = acam8,
                            Hypnosis_W1 = acam9,
                            ImageryTech_W1 = acam10,
                            Massage_W1 = acam11,
                            RelaxMeditate_W1 = acam13,
                            SpecialDiet_W1 = acam14, 
                            PraySpirit_W1 = acam21,
                            Education_W1 = AEduc,
                            Race_W1 = ARace,
                            Sex_W1 = ASex,
                            LogIncome_W1 = lnAHhInc,
                            Marital_W1 = aMarried,
                            HlthInsurance_W1 = aHlthIns,
                            Age_W1 = AAge,
                            AnyChron_W1 = A1SCHROX,
                            SumChron_W1 = A1SCHRON,
                            totalCams_W1 = totalCams, 
                            HLSelf_W1 = A1SHLOCS, 
                            HLOther_W1 = A1SHLOCO)

# Convert education to factor 
wave1$Education_W1 <- as_factor(wave1$Education_W1, levels = "labels")
# Convert Race to factor
wave1$Race_W1 <- as_factor(wave1$Race_W1, levels = "labels")
# Convert Sex to factor
wave1$Sex_W1 <- as_factor(wave1$Sex_W1, levels = "labels")
# Convert marital to factor
wave1$Marital_W1 <- as_factor(wave1$Marital_W1, levels = "labels")
# Convert Health insurance to factor
wave1$HlthInsurance_W1 <- as_factor(wave1$HlthInsurance_W1, levels = "labels")
# Convert Age to numeric 
wave1$Age_W1 <- as.numeric(wave1$Age_W1)
# Convert totalCams to numeric 
wave1$totalCams_W1 <- as.numeric(wave1$totalCams_W1)
# Convert sum chron to numeric 
wave1$SumChron_W1 <- as.numeric(wave1$SumChron_W1)
# Convert any chron to factor
wave1$AnyChron_W1 <- as_factor(wave1$AnyChron_W1, levels = "labels")
# Assign appropriate levels to NA
levels(wave1$AnyChron_W1)[levels(wave1$AnyChron_W1)=="Respondent does not have SAQ data"]<-NA
levels(wave1$AnyChron_W1)[levels(wave1$AnyChron_W1)=="Not calculated"]<-NA
# Convert HLSelf to numeric 
wave1$HLSelf_W1 <- as.numeric(wave1$HLSelf_W1)
# Convert HLOther to numeric
wave1$HLOther_W1 <- as.numeric(wave1$HLOther_W1)

str(wave1)

################################################################################
# Wave 2 
# Prayer and spiritual healing combined in stata.

# Read in MIDUS2 data and subset to complete cases on CAMs
# Read in stata file for MIDUS 2
path <- ("C:/Users/hanna/Documents/git/AHL/Stata/data-cleaning/MIDUS2.dta")
M2 <- read_dta(path)
varlist <- c("M2ID", "bcam1", "bcam2", "bcam3", "bcam4", "bcam5", "bcam6", "bcam7", 
               "bcam8", "bcam9", "bcam10", "bcam11", "bcam13", "bcam14", 
               "bcam21","bAge", "lnbHhInc", "bEduc", "bRace", "bSex", "bHlthIns", "bMarried",
               "B1SCHROX", "B1SCHRON", "B1SHLOCS", "B1SHLOCO")

wave2 <- M2[varlist] # Subset MIDUS2 - only include CAMs.


# Create column that is the sum of CAMs used 
wave2 <- wave2 %>% 
  mutate(totalCams = rowSums(wave2[, c(2:15)]))

# Rename columns 
wave2 <- dplyr::rename(wave2, 
                            Acupuncture_W2 = bcam1, 
                            Biofeedback_W2 = bcam2,
                            Chiropractic_W2 = bcam3,
                            EnergyHeal_W2 = bcam4,
                            ExerciseMove_W2 = bcam5,
                            Herbal_W2 = bcam6,
                            Vitamins_W2 = bcam7,
                            Homeopathy_W2 = bcam8,
                            Hypnosis_W2 = bcam9,
                            ImageryTech_W2 = bcam10,
                            Massage_W2 = bcam11,
                            RelaxMeditate_W2 = bcam13,
                            SpecialDiet_W2 = bcam14, 
                            PraySpirit_W2 = bcam21,
                            Age_W2 = bAge,
                            LogIncome_W2 = lnbHhInc,
                            Education_W2 = bEduc,
                            Race_W2 = bRace,
                            Sex_W2 = bSex,
                            HlthInsurance_W2 = bHlthIns,
                            Marital_W2 = bMarried, 
                            AnyChron_W2 = B1SCHROX,
                            SumChron_W2 = B1SCHRON,
                            totalCams_W2 = totalCams,
                            HLSelf_W2 = B1SHLOCS,
                            HLOther_W2 = B1SHLOCO)


# Convert age to numeric
wave2$Age_W2 <- as.numeric(wave2$Age_W2)
# Convert education to factor 
wave2$Education_W2 <- haven::as_factor(wave2$Education_W2, levels = "labels")
# Convert Race to factor 
wave2$Race_W2 <- haven::as_factor(wave2$Race_W2, levels = "labels")
# Convert sex to factor 
wave2$Sex_W2 <- haven::as_factor(wave2$Sex_W2, levels = "labels")
# Convert marital status to factor 
wave2$Marital_W2 <- haven::as_factor(wave2$Marital_W2, levels = "labels")
# Convert health insurance to factor
wave2$HlthInsurance_W2 <- haven::as_factor(wave2$HlthInsurance_W2, levels = "labels")
# Convert totalCams to numeric 
wave2$totalCams_W2 <- as.numeric(wave2$totalCams_W2)
# Convert sum to numeric 
wave2$SumChron_W2 <- as.numeric(wave2$SumChron_W2)
# Convert any chron to factor
wave2$AnyChron_W2 <- haven::as_factor(wave2$AnyChron_W2, levels = "labels")
# Rename levels to match wave 1. Wave 2 is in all caps, wave 1 is just capitalized. 
levels(wave2$AnyChron_W2)[levels(wave2$AnyChron_W2)=="NO"] <- "No"
levels(wave2$AnyChron_W2)[levels(wave2$AnyChron_W2)=="YES"] <- "Yes"
# Convert HLSelf to numeric 
wave2$HLSelf_W2 <- as.numeric(wave2$HLSelf_W2)
# Convert HLOther to numeric 
wave2$HLOther_W2 <- as.numeric(wave2$HLOther_W2)


################################################################################
# Wave 3 
# This chunk reads in the MIDUS2 Stata .dta file, subsets the data to only include CAMs, and restricts the data to complete cases. 

# Prayer and spiritual healing combined in stata.

# Read in MIDUS2 data and subset to complete cases on CAMs
# Read in stata file for MIDUS 2
path <- ("C:/Users/hanna/Documents/git/AHL/Stata/data-cleaning/MIDUS3.dta")
M3 <- read_dta(path)
varlist <- c("M2ID", "ccam1", "ccam2", "ccam3", "ccam4", "ccam5", "ccam6", "ccam7", 
               "ccam8", "ccam9", "ccam10", "ccam11", "ccam13", "ccam14", 
               "ccam21", "C1STATUS", "CAge", "lnCHhInc", "CEduc", "CRace", 
               "CSex", "cMarried", "cHlthIns", "C1SCHROX","C1SCHRON", "C1SHLOCS", "C1SHLOCO")

wave3 <- M3[varlist] # Subset MIDUS2 - only include CAMs.

# Create column that is the sum of CAMs used 
wave3 <- wave3 %>% 
  mutate(totalCams = rowSums(wave3[, c(2:15)]))

# Rename columns 
wave3 <- dplyr::rename(wave3, 
                            Acupuncture_W3 = ccam1, 
                            Biofeedback_W3 = ccam2,
                            Chiropractic_W3 = ccam3,
                            EnergyHeal_W3 = ccam4,
                            ExerciseMove_W3 = ccam5,
                            Herbal_W3 = ccam6,
                            Vitamins_W3 = ccam7,
                            Homeopathy_W3 = ccam8,
                            Hypnosis_W3 = ccam9,
                            ImageryTech_W3 = ccam10,
                            Massage_W3 = ccam11,
                            RelaxMeditate_W3 = ccam13,
                            SpecialDiet_W3 = ccam14,
                            PraySpirit_W3 = ccam21,
                            Age_W3 = CAge,
                            LogIncome_W3 = lnCHhInc,
                            Education_W3 = CEduc,
                            Race_W3 = CRace,
                            Sex_W3 = CSex,
                            Marital_W3 = cMarried,
                            HlthInsurance_W3 = cHlthIns, 
                            AnyChron_W3 = C1SCHROX,
                            SumChron_W3 = C1SCHRON,
                            HLSelf_W3 = C1SHLOCS,
                            HLOther_W3 = C1SHLOCO,
                            totalCams_W3 = totalCams)
str(wave3)

# Age and income already set as numeric 
# Convert education to factor 
wave3$Education_W3 <- haven::as_factor(wave3$Education_W3, levels = "labels")
# Convert race to factor
wave3$Race_W3 <- haven::as_factor(wave3$Race_W3, levels = "labels")
# Convert sex to factor 
wave3$Sex_W3 <- haven::as_factor(wave3$Sex_W3, levels = "labels")
# Convert marital to factor 
wave3$Marital_W3 <- haven::as_factor(wave3$Marital_W3, levels = "labels")
# Convert health insurance to factor 
wave3$HlthInsurance_W3 <- haven::as_factor(wave3$HlthInsurance_W3, levels = "labels")
# Convert totalCams to numeric 
wave3$totalCams_W3 <- as.numeric(wave3$totalCams_W3)
# Convert Sum chron to numeric 
wave3$SumChron_W3 <- as.numeric(wave3$SumChron_W3)
# Convert any chron to factor
wave3$AnyChron_W3 <- haven::as_factor(wave3$AnyChron_W3, levels = "labels")
# Assign appropriate levels on any chron to NA 
levels(wave3$AnyChron_W3)[levels(wave3$AnyChron_W3)=="RESPONDENT DOES NOT HAVE SAQ DATA"]<-NA
levels(wave3$AnyChron_W3)[levels(wave3$AnyChron_W3)=="NOT CALCULATED (Due to missing data)"]<-NA
# Rename levels to match wave 1. Wave 2 is in all caps, wave 1 is just capitalized. 
levels(wave3$AnyChron_W3)[levels(wave3$AnyChron_W3)=="NO"] <- "No"
levels(wave3$AnyChron_W3)[levels(wave3$AnyChron_W3)=="YES"] <- "Yes"
# Convert HLSelf to numeric
wave3$HLSelf_W3 <- as.numeric(wave3$HLSelf_W3)
# Convert HLOther to numeric 
wave3$HLOther_W3 <- as.numeric(wave3$HLOther_W3)

################################################################################
# create waves with only complete cases

# wave 3
# Convert C1STATUS to factor 
#wave3$C1STATUS <- as_factor(wave3$C1STATUS, levels = "values")

# Drop incomplete cases
#wave3 <- wave3[complete.cases(wave3),]



library(skimr)

# Convert back to wide format
#complete.waves.wide <- widen_panel(waves123.long, separator = "_")
# Okay may not have been necessary to convert to long. Just take complete cases from the wide dataset. 
#dim(complete.waves.wide)
# complete.waves.wide <- complete.waves.wide[complete.cases(complete.waves.wide),]
#dim(complete.waves.wide)

# Subset wave 1
varlist <- c("Acupuncture_1", "Biofeedback_1", "Chiropractic_1", "EnergyHeal_1", "ExerciseMove_1", "Herbal_1", "Vitamins_1", "Homeopathy_1", "Hypnosis_1", "ImageryTech_1", "Massage_1", "RelaxMeditate_1", "SpecialDiet_1", "PraySpirit_1")
# wave1 <- complete.waves.wide[varlist]

# Subset wave 2 
varlist <- c("Acupuncture_2", "Biofeedback_2", "Chiropractic_2", "EnergyHeal_2", "ExerciseMove_2", "Herbal_2", "Vitamins_2", "Homeopathy_2", "Hypnosis_2", "ImageryTech_2", "Massage_2", "RelaxMeditate_2", "SpecialDiet_2", "PraySpirit_2")
#wave2 <- complete.waves.wide[varlist]

# subset wave 3
varlist <- c("Acupuncture_3", "Biofeedback_3", "Chiropractic_3", "EnergyHeal_3", "ExerciseMove_3", "Herbal_3", "Vitamins_3", "Homeopathy_3", "Hypnosis_3", "ImageryTech_3", "Massage_3", "RelaxMeditate_3", "SpecialDiet_3", "PraySpirit_3")
#wave3 <- complete.waves.wide[varlist]

setwd("~/git/AHL/R")

save(wave1, file = "wave1complete.rda")
save(wave2, file = "wave2complete.rda")
save(wave3, file = "wave3complete.rda")

# Create dummies for each factor
```

```{r, echo = FALSE}
# This code chunk creates the factor dummy indices 
# Factor 1: Mind body practices 

# wave 1
wave1$mindbody_W1 <- rowSums(wave1[, c("PraySpirit_W1", "EnergyHeal_W1", "ImageryTech_W1",
                                    "RelaxMeditate_W1", "Hypnosis_W1")], na.rm = FALSE)
wave1$mindbody_W1[wave1$mindbody_W1 > 0] <- 1 

# wave 2
wave2$mindbody_W2 <- rowSums(wave2[, c("PraySpirit_W2", "EnergyHeal_W2", "ImageryTech_W2",
                                    "RelaxMeditate_W2", "Hypnosis_W2")])
wave2$mindbody_W2[wave2$mindbody_W2 > 0] <- 1

#wave 3
wave3$mindbody_W3 <- rowSums(wave3[, c("PraySpirit_W3", "EnergyHeal_W3", "ImageryTech_W3",
                                    "RelaxMeditate_W3", "Hypnosis_W3")])
wave3$mindbody_W3[wave3$mindbody_W3 > 0] <- 1

# Factor 2: Alternative medical systems
# wave 1
wave1$altmed_W1 <- rowSums(wave1[, c("Homeopathy_W1", "Herbal_W1", "Acupuncture_W1")])
wave1$altmed_W1[wave1$altmed_W1 > 0] <- 1
# wave 2
wave2$altmed_W2 <- rowSums(wave2[, c("Homeopathy_W2", "Herbal_W2", "Acupuncture_W2")])
wave2$altmed_W2[wave2$altmed_W2 > 0] <- 1
# wave 3
wave3$altmed_W3 <- rowSums(wave3[, c("Homeopathy_W3", "Herbal_W3", "Acupuncture_W3")])
wave3$altmed_W3[wave3$altmed_W3 > 0] <- 1

# Factor 3: Physical and Nutritional Approaches
wave1$pna_W1 <- rowSums(wave1[, c("Vitamins_W1", "ExerciseMove_W1", "SpecialDiet_W1")])
wave1$pna_W1[wave1$pna_W1 > 0] <- 1
wave2$pna_W2 <- rowSums(wave2[, c("Vitamins_W2", "ExerciseMove_W2", "SpecialDiet_W2")])
wave2$pna_W2[wave2$pna_W2 > 0] <- 1
wave3$pna_W3 <- rowSums(wave3[, c("Vitamins_W3", "ExerciseMove_W3", "SpecialDiet_W3")])
wave3$pna_W3[wave3$pna_W3 > 0] <- 1

# Factor 4: Manipulative treatments
wave1$manipulative_W1 <- rowSums(wave1[, c("Massage_W1", "Chiropractic_W1")])
wave1$manipulative_W1[wave1$manipulative_W1 > 0] <- 1
wave2$manipulative_W2 <- rowSums(wave2[, c("Massage_W2", "Chiropractic_W2")])
wave2$manipulative_W2[wave2$manipulative_W2 > 0] <- 1
wave3$manipulative_W3 <- rowSums(wave3[, c("Massage_W3", "Chiropractic_W3")])
wave3$manipulative_W3[wave3$manipulative_W3 > 0] <- 1

save(wave1, file = "wave1complete.rda")
save(wave2, file = "wave2complete.rda")
save(wave3, file = "wave3complete.rda")
```
```{r, echo = FALSE}

################################################################################
# Reshaping and merging all three waves 

# These include incomplete cases
# Merge a.cams.lta to b.cams.lta
merge1 <- merge(wave1, wave2, by = "M2ID")
# Merge cams.lta.1 and c.cams.lta
wide.waves123 <- merge(merge1, wave3, by = "M2ID")

library(panelr)

# Reshape wide to long: this is the dataset with all respondents to be used further down 
waves123.long <- long_panel(wide.waves123, prefix = "_W", begin = 1, end = 3, label_location = "end")

save(waves123.long, file = "waves123.long.rda")

# Drop incomplete cases for cams.complete.  
dim(waves123.long)
#waves123.long.complete <- waves123.long[complete.cases(waves123.long),]
#dim(waves123.long.complete)



```
